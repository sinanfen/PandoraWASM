@page "/pages/authentication/register"
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@using Pandora.Shared.DTOs.UserDTOs
@using Pandora.Shared.Enums
@using PandoraWASM.Services
@using PandoraWASM.Shared
@layout LoginLayout

<MudText Typo="Typo.h4" GutterBottom="true">Sign Up</MudText>
<MudText>Already have an account? <MudLink Href="/auth/login">Sign In</MudLink></MudText>

<MudTextField T="string" @bind-Value="registerModel.Username" Label="Username" Variant="Variant.Outlined" Class="my-4" />

<MudTextField T="string" @bind-Value="registerModel.Email" Label="E-mail" Variant="Variant.Outlined" />

<MudTextField T="string" @bind-Value="registerModel.Password" Label="Password" Variant="Variant.Outlined" InputType="@PasswordInput" Adornment="Adornment.End" AdornmentIcon="@PasswordInputIcon" OnAdornmentClick="TogglePasswordVisibility" Class="mt-4" />

<MudTextField T="string" @bind-Value="registerModel.ConfirmPassword" Label="Confirm Password" Variant="Variant.Outlined" InputType="InputType.Password" Class="mt-4" />

<MudTextField T="string" @bind-Value="registerModel.PhoneNumber" Label="Phone Number" Variant="Variant.Outlined" Class="mt-4" />

<MudTextField T="string" @bind-Value="registerModel.FirstName" Label="First Name" Variant="Variant.Outlined" Class="mt-4" />

<MudTextField T="string" @bind-Value="registerModel.LastName" Label="Last Name" Variant="Variant.Outlined" Class="mt-4" />

<MudTextField T="string" @bind-Value="registerModel.CompanyName" Label="Company Name" Variant="Variant.Outlined" Class="mt-4" />

<MudTextField T="string" @bind-Value="registerModel.TaxNumber" Label="Tax Number" Variant="Variant.Outlined" Class="mt-4" />

<MudSelect T="UserType" @bind-Value="registerModel.UserType" Label="User Type" Variant="Variant.Outlined" Class="mt-4">
    <MudSelectItem Value="UserType.Individual">Individual</MudSelectItem>
    <MudSelectItem Value="UserType.Corporate">Company</MudSelectItem>
</MudSelect>

<MudCheckBox T="bool" @bind-Checked="AgreeToTerms" Label="I agree to the terms and privacy" Color="Color.Primary" Class="ml-n1 my-3" />

<MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!AgreeToTerms)" Size="Size.Large" FullWidth="true" OnClick="RegisterAsync">Register</MudButton>

@code {
    private UserRegisterDto registerModel = new UserRegisterDto();
    private bool AgreeToTerms { get; set; }
    private bool PasswordVisibility;
    private InputType PasswordInput = InputType.Password;
    private string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    private async Task RegisterAsync()
    {
        if (await AuthService.RegisterAsync(registerModel))
        {
            Snackbar.Add("Registration successful! Redirecting to login...", Severity.Success);
            Navigation.NavigateTo("/auth/login");
        }
        else
        {
            Snackbar.Add("Registration failed. Please check your details and try again.", Severity.Error);
        }
    }

    private void TogglePasswordVisibility()
    {
        if (PasswordVisibility)
        {
            PasswordVisibility = false;
            PasswordInputIcon = Icons.Material.Filled.VisibilityOff;
            PasswordInput = InputType.Password;
        }
        else
        {
            PasswordVisibility = true;
            PasswordInputIcon = Icons.Material.Filled.Visibility;
            PasswordInput = InputType.Text;
        }
    }
}
