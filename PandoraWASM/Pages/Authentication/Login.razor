@page "/auth/login"

@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Pandora.Shared.DTOs.UserDTOs
@using PandoraWASM.Services
@using PandoraWASM.Services.Interfaces
@using PandoraWASM.Shared

@inject ISnackbar Snackbar
@inject CustomAuthenticationStateProvider LoginAuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IAuthService AuthService
@inject ILocalStorageService LocalStorageService
@layout LoginLayout

<MudPaper Elevation="5" Width="550px" Class="pa-6" Style="border-radius: 12px;">
    <!-- Login and Register Links -->
    <MudStack Row AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudText Typo="Typo.h4" GutterBottom>LOG IN</MudText>
        <MudLink Href="/pages/authentication/register" Color="Color.Primary" Underline="Underline.Hover">
            OR CREATE AN ACCOUNT
        </MudLink>
    </MudStack>

    <!-- Error Alert -->
    @if (loginFailed)
    {
        <MudAlert Severity="Severity.Error" Dense="true" Class="mb-4">
            Incorrect username or password
        </MudAlert>
    }

    <!-- Email Address Field -->
    <MudTextField T="string"
                  @bind-Value="@userLoginDto.UsernameOrEmail"
                  Label="Email address"
                  Variant="Variant.Outlined"
                  FullWidth="true"
                  Required="true" />

    <!-- Password Field -->
    <MudTextField @bind-Value="@userLoginDto.Password"
                  Label="Master Password"
                  Variant="Variant.Outlined"
                  InputType="@PasswordInput"
                  Adornment="Adornment.End"
                  AdornmentIcon="@PasswordInputIcon"
                  OnAdornmentClick="TogglePasswordVisibility"
                  FullWidth="true"
                  Required="true"
                  Class="mt-4" />

    <!-- Login Button -->
    <MudButton Variant="Variant.Filled"
               Color="Color.Warning"
               FullWidth="true"
               Class="mt-6"
               Style="height: 48px; border-radius: 24px; font-weight: bold;"
               OnClick="HandleLogin">
        LOG IN
    </MudButton>

    <!-- Forgot Password Link -->
    <MudLink Href="#" Class="d-block text-center mt-4" Color="Color.Primary" Underline="Underline.Hover">
        FORGOT PASSWORD?
    </MudLink>
</MudPaper>

@code {
    bool PasswordVisibility;
    InputType PasswordInput = InputType.Password;
    string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    void TogglePasswordVisibility()
    {
        PasswordVisibility = !PasswordVisibility;
        PasswordInput = PasswordVisibility ? InputType.Text : InputType.Password;
        PasswordInputIcon = PasswordVisibility ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private UserLoginDto userLoginDto = new UserLoginDto();
    private bool loginFailed = false;

    private async Task HandleLogin()
    {
        var cts = new CancellationTokenSource();
        var (success, message, token) = await AuthService.LoginAsync(userLoginDto, cts.Token);

        if (success && token != null)
        {
            await LoginAuthenticationStateProvider.NotifyUserAuthentication(token);
            loginFailed = false;
            NavigationManager.NavigateTo("/home/dashboard", forceLoad: true);
        }
        else
        {
            loginFailed = true;
            Snackbar.Add(message, Severity.Error);
        }
    }
}
